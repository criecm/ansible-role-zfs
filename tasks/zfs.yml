---
- name: stat dir
  stat:
    path: '{{ zfs.path }}'
  register: dirstat
  when: '"path" in zfs'

- name: merge vars
  include_vars: zfs.yml

- name: get origin size
  zfs_facts:
    name: '{{ zfs.origin | regex_replace("@.*","") }}'
    properties: volsize
  register: zorig_facts
  when: '"origin" in zfs'

- name: 'zfs {{ zfs.zfsrc }}'
  zfs:
    name: '{{ zfs.zfsrc }}'
    state: present
    origin: '{{ zfs.origin | default(omit) }}'
    extra_zfs_properties: '{{ zfsprops }}'
  register: newzfs

- name: fail if volsize < origin
  fail:
    msg: 'volsize({{ zfs.volsize }}) < zfs.origin.volsize({{ zorig_facts.ansible_facts.ansible_zfs_datasets[0].volsize }})'
  when: '"origin" in zfs and zfs.origin is defined and zfs.origin is search("@")
    and "volsize" in zfs and zfs.volsize is defined and zfs.volsize is match("[0-9].*")
    and "volsize" in zorig_facts.ansible_facts.ansible_zfs_datasets[0] and zorig_facts.ansible_facts.ansible_zfs_datasets[0].volsize is match("[0-9].*")
    and zfs.volsize | regex_replace("G","") | float <
      zorig_facts.ansible_facts.ansible_zfs_datasets[0].volsize | regex_replace("G","") | float'

- name: resize zfs volume
  zfs:
    name: '{{ zfs.zfsrc }}'
    state: present
    extra_zfs_properties:
      volsize: '{{ zfs.volsize }}'
  when: '"volsize" in zfs and zfs.volsize is defined and zfs.volsize is match("[0-9].*")'

- name: restore from backup if restore==1
  command: '{{ zfs_sync_vol }} -BRCzs {{ zfs.backup_on }} {{ zfs.zfsrc }}'
  when: restore and "backup_on" in zfs and ( not dirstat.stat.exists or newzfs.changed )

- name: chown/mod dir
  file:
    path: '{{ zfs.path }}'
    mode: '{{ zfs.mode | default(omit) }}'
    owner: '{{ zfs.owner | default(omit) }}'
    group: '{{ zfs.group | default(omit) }}'
    state: directory
  when: '"path" in zfs and ( "owner" in zfs or "group" in zfs ) and ( newzfs.changed or reshare | default(False) )'

- name: setfacl
  acl:
    entry: '{{ item }}'
    path: '{{ zfs.path }}'
    use_nfsv4_acls: '{{ nfsv4_acls }}'
    state: present
  with_items: '{{ zfs.acls | default([]) }}'
  when: newzfs.changed
